<!-- ~/ve2pcq/ve2fet/webapp/templates/validators.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Valar ‚Äì Validator overview</title>

  <!-- Bootstrap 5 (CSS only) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet" integrity="sha384-..." crossorigin="anonymous">
  <!-- DataTables Bootstrap CSS -->
  <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
        rel="stylesheet">

  <style>
    body { font-family: Arial, sans-serif; padding: 1.5rem; }

    /* Hover highlight */
    table.dataTable tbody tr:hover {
      background: #f6f6f6;
    }

    /* Monospace & no-wrap for the first column */
    table.dataTable th:first-child,
    table.dataTable td:first-child {
      font-family: monospace;
      white-space: nowrap;
      padding-right: 1ch;
    }

    /* Right-align every column except the first */
    table.dataTable th:not(:first-child),
    table.dataTable td:not(:first-child) {
      text-align: right;
    }
    /* force every avatar in the first cell to 16 px and keep it centred */
    td:first-child img { height:16px; vertical-align:middle; }

    /* clipped owner address (same rules as delegator page) */
    .addr-clip{
      display:inline-block;
      max-width:140px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-family:monospace;
      line-height:16px;
    }


  </style>
</head>
<body>

<h3 class="mb-3">Validator Owners ‚Äì live snapshot</h3>

<p class="small text-muted mb-0">
  Page loaded since‚Ä¶ <span id="age">0 s</span> ago. Reload page for most recent data.
  <span id="algoPrice"></span><span class="text-muted"> (updates every 60 s)</span>
  <span class="ms-3">
    Fees ALGO/mo (filtered): <strong>{{ '%.2f' % algo_fee_sum }}
    (US${{ '%.2f' % fee_usd }}
    + USDC${{ '%.2f' % usdc_usd }}
    = US${{ '%.2f' % fee_usd_total }}
    = CDN${{ '%.2f' % fee_cad_total }})}</strong>
    : 1 US Dollar = {{ '%.6f' % usd_cad }} CDN
  </span>
</p>

<table id="valTable" class="table table-sm table-striped table-bordered">
  <thead class="table-light">
    <tr>
      <th>Owner&nbsp;Addr</th>
      <th>Ads</th>
      <th>Dels</th>
      <th class="text-end">Stake&nbsp;ALGO</th>
      <th class="text-end">Stake&nbsp;USDC</th>
      <th class="text-end">Grand&nbsp;Total</th>
      <th class="text-end">%&nbsp;of&nbsp;Total</th>
      <th class="text-end">Fees&nbsp;ALGO&nbsp;/mo</th>
      <th class="text-end">Fees&nbsp;USDC&nbsp;/mo</th>
    </tr>
  </thead>
  <tbody>
  {% for r in rows %}
    <tr>

<td>
  <span style="display:inline-flex; align-items:center; gap:0.3em; white-space:nowrap;">

    <!-- magnifier -->
    <a href="/delegators/?owner={{ r.val_owner }}" target="_blank"
       title="See this validator clients" style="text-decoration:none;">üîç</a>

    <!-- allo.info -->
    <a href="https://allo.info/account/{{ r.val_owner }}" target="_blank"
       title="Open on allo.info" style="display:inline-block;">
       <img src="https://allo.info/favicons/favicon.ico" style="height:16px;">
    </a>

    <!-- NFD avatar (16 px via CSS) -->
    {% if r.nfd_avatar %}<img src="{{ r.nfd_avatar }}">{% endif %}

    <!-- NFD name or short addr -->
    {% if r.nfd_name %}
        <strong>{{ r.nfd_name }}</strong>
    {% endif %}

    <!-- clipped full address (copy-able) -->
    <span class="addr-clip">{{ r.val_owner }}</span>
  </span>
</td>


      <td>{{ r.ads }}</td>
      <td>{{ r.dels }}</td>
      <td>{{ '{:,.0f}'.format(r.stake_algo) }}</td>
      <td>{{ '{:,.0f}'.format(r.stake_usdc) }}</td>
      <td>{{ '{:,.0f}'.format(r.grand_total) }}</td>
      <td>{{ '{:5.1f}'.format(r.grand_total / total.grand_total * 100) }}%</td>
      <td>{{ '{:,.2f}'.format(r.fee_algo) }}</td>
      <td>{{ '{:,.2f}'.format(r.fee_usdc) }}</td>
    </tr>
  {% endfor %}
  </tbody>
  <tfoot class="table-light">
    <tr>
      <th>Total</th>
      <th>{{ total.ads }}</th>
      <th>{{ total.dels }}</th>
      <th>{{ '{:,.0f}'.format(total.stake_algo) }}</th>
      <th>{{ '{:,.0f}'.format(total.stake_usdc) }}</th>
      <th>{{ '{:,.0f}'.format(total.grand_total) }}</th>
      <th>100&nbsp;%</th>
      <th>{{ '{:,.2f}'.format(total.fee_algo) }}</th>
      <th>{{ '{:,.2f}'.format(total.fee_usdc) }}</th>
    </tr>
  </tfoot>
</table>

<p class="small text-muted">
  Snapshot generated when this page was rendered ‚Äì reload to refresh.
</p>

<!-- JS bundles -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(function () {
    $('#valTable').DataTable({
      paging: false,
      order: [[5, 'desc']],    // sort by grand_total
      autoWidth: false         // size columns to data, not header
    });
  });

const PAGE_TS = {{ page_ts }};        // injected by Jinja

function fmt(ms){
  const s = Math.floor(ms/1000),
        m = Math.floor((s%3600)/60),
        h = Math.floor(s/3600);
  return (h ? String(h).padStart(2,'0')+':' : '') +
         String(m).padStart(2,'0') + ':' +
         String(s%60).padStart(2,'0');
}

function tick(){
  document.getElementById('age').textContent = fmt(Date.now() - PAGE_TS);
}
tick(); setInterval(tick, 1000);


 function fetchAlgoPrice () {
    fetch('https://api.coingecko.com/api/v3/simple/price?ids=algorand&vs_currencies=usd')
      .then(r => r.json())
      .then(j => {
        const p = j.algorand?.usd;
        if (p) {
          document.getElementById('algoPrice').textContent = ` ¬∑ ALGO ‚âà US$${p.toFixed(4)}`;
        }
      })
      .catch(() => {/* ignore network / CORS errors silently */});
  }
  fetchAlgoPrice();                 // run once on load
  setInterval(fetchAlgoPrice, 60_000); // refresh every 60 s

</script>
</body>
</html>
