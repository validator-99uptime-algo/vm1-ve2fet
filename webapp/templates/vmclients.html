<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Participation Keys by VM</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <style>
    /* speed up collapse animation */
    .collapse {
      transition: height 0.2s ease;
    }
    /* slimmer headers & borders */
    .accordion .accordion-item + .accordion-item {
      border-top: 1px solid #dee2e6;
    }
    .accordion-button {
      padding: 0.4rem 1rem;
      font-size: 0.95rem;
    }
    .accordion-body .table th,
    .accordion-body .table td {
      padding: 0.3rem 0.5rem;
    }
  </style>
</head>
<body class="p-4">

<h3>
  Participation Keys by VM
  <small class="text-muted">As of {{ as_of }}</small>
</h3>

<p class="small text-muted">
  Page loaded since… <span id="age">0 s</span> ago. Reload page for most recent data.
</p>

<form class="mb-3 row g-2" method="get">
  <div class="col-auto">
    <label class="form-label">VM #</label>
    <input name="vm" class="form-control" value="{{ vm_filter or '' }}">
  </div>
  <div class="col-auto">
    <button class="btn btn-primary mt-4">Filter</button>
  </div>
  <div class="col-auto align-self-end text-muted">
    (leave blank → all)
  </div>
</form>

<div class="accordion" id="vmAccordion">
  {% for block in blocks %}
  <div class="accordion-item">
    <h2 class="accordion-header" id="heading{{ loop.index }}">
      <button class="accordion-button collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse{{ loop.index }}">
        VM {{ block.vm }} ({{ block.count }} keys)
      </button>
    </h2>
    <div id="collapse{{ loop.index }}"
         class="accordion-collapse collapse"
         data-bs-parent="#vmAccordion">
      <div class="accordion-body p-0">
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Parent Address</th>
              <th>Last Round</th>
              <th>Expiry</th>
              <th>Time Left</th>
            </tr>
          </thead>
          <tbody>
            {% for key in block['keys'] %}
            <tr>
              <td><code>{{ key.parent_address }}</code></td>
              <td>{{ key.last_round }}</td>
              <td>{{ key.expiry.strftime("%Y-%m-%d %H:%M") }}</td>
              <td>{{ key.time_left }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// “loaded since…” clock
const PAGE_TS = {{ page_ts }};
function fmt(ms) {
  const s = Math.floor(ms/1000),
        m = Math.floor((s%3600)/60),
        h = Math.floor(s/3600);
  return (h ? String(h).padStart(2,'0')+':' : '') +
         String(m).padStart(2,'0') + ':' +
         String(s%60).padStart(2,'0');
}
function tick(){
  document.getElementById('age').textContent = fmt(Date.now() - PAGE_TS);
}
tick(); setInterval(tick, 1000);
</script>

</body>
</html>
